import{_ as ct,x as ut,r as n,o as vt,z as N,p as pt,c as l,a as t,t as i,A as b,l as I,b as mt,F as L,e as U,n as B,d as ft,i as gt,w as ht,v as yt,f as r,s as wt}from"./index-D1wTDwKK.js";import{$ as xt}from"./bundler-DyOlRpoC.js";import{getApps as _t,initializeApp as Ct,getApp as kt}from"https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";import{getFirestore as bt,doc as H,getDoc as Dt,updateDoc as St,collection as T,query as O,where as Mt,getDocs as Pt,onSnapshot as q,orderBy as At,addDoc as It,serverTimestamp as Lt}from"https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";import"./_commonjsHelpers-gnU0ypJ3.js";const Ut={id:"watch-root"},Bt={key:0,class:"loading-container"},Tt={class:"loading-content"},$t={key:1,class:"not-found-container"},Rt={key:2,class:"stream-container"},Vt={class:"left-pane"},Ft={class:"stream-header"},zt={class:"host-info"},Et={class:"host-avatar"},Nt={class:"avatar-circle"},Ht={class:"host-details"},Ot={class:"host-name"},qt={class:"participants-section"},Qt={class:"participants-count"},jt={class:"count-number"},Kt={class:"audio-section"},Wt={class:"audio-container"},Gt={class:"audio-visualizer"},Jt={class:"audio-controls"},Xt={key:0,width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},Yt={key:1,width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},Zt={class:"stream-status"},te={class:"interaction-section"},ee={class:"stream-stats"},se={class:"stat-item"},ae={class:"stat-info"},oe={class:"stat-value"},ne={class:"stat-item"},ie={class:"stat-info"},le={class:"stat-value"},re={class:"stat-item"},de={class:"stat-info"},ce={class:"recent-listeners"},ue={class:"listener-avatars"},ve={key:0,class:"listener-more"},pe={class:"chat-pane"},me={class:"messages-container",ref:"messagesContainer"},fe={class:"msg-sender"},ge={class:"msg-text"},he={class:"msg-time"},ye={__name:"WatchingView",setup(we){const Q={apiKey:"AIzaSyAQpMoxAKJrkave5D9e8CqKeLffCCUeGAw",authDomain:"vexa-d596e.firebaseapp.com",projectId:"vexa-d596e",storageBucket:"vexa-d596e.appspot.com",messagingSenderId:"79833394084",appId:"1:79833394084:web:1e5f41859b4125ef342f31"},j=_t().length===0?Ct(Q):kt(),w=bt(j),d=ut().params.owner,g=n(!0),h=n(!1),_=n(null),u=n(null),x=n(0),C=n(!1),$=n(!1),R=n(0),m=n({text:"Excellent",class:"good"}),V=n(["Alice","Bob","Charlie","Diana","Eve"]);let D=null,S=null,f=null;const F=n([]),k=n(""),v=n("");function K(a){const e=Math.floor(a/60),s=a%60;return`${e}:${s.toString().padStart(2,"0")}`}function W(a){if(!a)return"";const e=a.toDate(),s=e.getHours().toString().padStart(2,"0"),o=e.getMinutes().toString().padStart(2,"0");return`${s}:${o}`}function G(a){const s=`; ${document.cookie}`.split(`; ${a}=`);return s.length===2?decodeURIComponent(s.pop().split(";").shift()):null}async function J(a){const e=T(w,"vexaUsers"),s=O(e,Mt("username","==",a)),o=await Pt(s);return o.empty?null:{id:o.docs[0].id,...o.docs[0].data()}}function X(){C.value=!0,st()}function Y(){C.value=!1,at()}function Z(){m.value={text:"Loading...",class:"loading"}}function tt(){m.value={text:"Excellent",class:"good"}}function et(){u.value&&(u.value.muted=!u.value.muted,$.value=u.value.muted)}function st(){f||(f=setInterval(()=>{R.value++},1e3))}function at(){f&&(clearInterval(f),f=null)}function ot(){navigator.share?navigator.share({title:`${d}'s Live Stream`,text:`Listen to ${d}'s live audio stream`,url:window.location.href}):(navigator.clipboard.writeText(window.location.href),alert("Stream link copied to clipboard!"))}function nt(){document.querySelector(".stream-container").classList.toggle("fullscreen-mode")}function it(){g.value=!0,h.value=!1,window.location.reload()}function lt(){const a=H(w,"vexaRooms",d);D=q(a,e=>{if(e.exists()){const o=e.data()["Participants-Usernames"]||[];x.value=o.length,V.value=o.slice(-5)}})}function z(){const a=T(w,"vexaChats",d,"messages"),e=O(a,At("timestamp","asc"));S=q(e,s=>{const o=[];s.forEach(c=>{const y=c.data();o.push({id:c.id,sender:y.sender,text:y.text,timestamp:y.timestamp})}),F.value=o,N(()=>{const c=dt.value;c&&(c.scrollTop=c.scrollHeight)})})}async function rt(){const a=k.value.trim();if(!a)return;const e=T(w,"vexaChats",d,"messages");try{await It(e,{sender:v.value,text:a,timestamp:Lt()}),k.value=""}catch(s){console.error("Failed to send message:",s)}}vt(async()=>{const a=G("vexaUser");if(!a){console.error("No logged-in username in cookies"),g.value=!1,h.value=!1;return}v.value=a;const e=await J(v.value);if(!e||!e.PeerID){console.error("Viewer not found or missing PeerID for",v.value),g.value=!1,h.value=!1;return}const s=e.PeerID;let o;try{o=await navigator.mediaDevices.getUserMedia({audio:!0})}catch(p){console.warn("No mic access, using empty stream",p),o=new MediaStream}const c=H(w,"vexaRooms",d),y=await Dt(c);if(!y.exists()){h.value=!1,g.value=!1;return}_.value=y.data(),h.value=!0,g.value=!1,lt();const E=_.value["Participants-Usernames"]||[];if(!E.includes(v.value))try{await St(c,{"Participants-Usernames":[...E,v.value]})}catch(p){console.error("Failed to update participants:",p)}if(_.value["Room-Owner"]===v.value){z();return}const M=new xt(s);M.on("open",()=>{const p=_.value["Room-Owner-PeerID"];if(!p){console.error("Host PeerID missing for",d);return}const P=M.call(p,o);if(!P){console.error("Call returned undefinedâ€”check PeerIDs & stream");return}P.on("stream",async A=>{await N(),u.value&&(u.value.srcObject=A,u.value.onloadeddata=()=>{m.value={text:"Connected",class:"good"}})}),P.on("error",A=>{console.error("Call error:",A),m.value={text:"Poor",class:"poor"}})}),M.on("error",p=>{console.error("Peer error:",p),m.value={text:"Disconnected",class:"poor"}}),z()}),pt(()=>{D&&D(),S&&S(),f&&clearInterval(f)});const dt=n(null);return(a,e)=>(r(),l("div",Ut,[g.value?(r(),l("div",Bt,[e[3]||(e[3]=t("div",{class:"loading-spinner"},null,-1)),t("div",Tt,[e[1]||(e[1]=t("h2",null,"Connecting to Stream...",-1)),t("p",null,"Finding "+i(b(d))+"'s audio stream",1),e[2]||(e[2]=t("div",{class:"loading-dots"},[t("span"),t("span"),t("span")],-1))])])):h.value?(r(),l("div",Rt,[t("div",Vt,[t("div",Ft,[t("div",zt,[t("div",Et,[t("div",Nt,i(b(d).charAt(0).toUpperCase()),1),e[7]||(e[7]=t("div",{class:"live-indicator"},[t("div",{class:"live-dot"}),I(" LIVE ")],-1))]),t("div",Ht,[t("h1",Ot,i(b(d)),1),e[8]||(e[8]=t("p",{class:"stream-title"},"Live Audio Stream",-1))])]),t("div",qt,[t("div",Qt,[e[9]||(e[9]=mt('<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-v-3a4d492a><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" data-v-3a4d492a></path><circle cx="9" cy="7" r="4" data-v-3a4d492a></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87" data-v-3a4d492a></path><path d="M16 3.13a4 4 0 0 1 0 7.75" data-v-3a4d492a></path></svg>',1)),t("span",jt,i(x.value),1),e[10]||(e[10]=t("span",{class:"count-label"},"listening",-1))]),e[11]||(e[11]=t("div",{class:"participants-pulse"},null,-1))])]),t("div",Kt,[t("div",Wt,[t("div",Gt,[(r(),l(L,null,U(12,s=>t("div",{class:"visualizer-bars",key:s,style:wt({animationDelay:s*.1+"s"})},null,4)),64))]),t("audio",{ref_key:"remoteAudio",ref:u,controls:"",autoplay:"",playsinline:"",class:"audio-player",onPlay:X,onPause:Y,onLoadstart:Z,onCanplay:tt},null,544),t("div",Jt,[t("button",{class:"volume-btn",onClick:et},[$.value?(r(),l("svg",Yt,e[13]||(e[13]=[t("polygon",{points:"11 5 6 9 2 9 2 15 6 15 11 19 11 5"},null,-1),t("line",{x1:"23",y1:"9",x2:"17",y2:"15"},null,-1),t("line",{x1:"17",y1:"9",x2:"23",y2:"15"},null,-1)]))):(r(),l("svg",Xt,e[12]||(e[12]=[t("polygon",{points:"11 5 6 9 2 9 2 15 6 15 11 19 11 5"},null,-1),t("path",{d:"M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"},null,-1)])))]),t("div",Zt,[t("div",{class:B(["status-dot",{active:C.value}])},null,2),t("span",null,i(C.value?"Live":"Paused"),1)])])])]),t("div",te,[t("div",ee,[t("div",se,[e[15]||(e[15]=t("div",{class:"stat-icon"},"ðŸŽµ",-1)),t("div",ae,[t("span",oe,i(K(R.value)),1),e[14]||(e[14]=t("span",{class:"stat-label"},"Stream Time",-1))])]),t("div",ne,[e[17]||(e[17]=t("div",{class:"stat-icon"},"ðŸ‘¥",-1)),t("div",ie,[t("span",le,i(x.value),1),e[16]||(e[16]=t("span",{class:"stat-label"},"Listeners",-1))])]),t("div",re,[e[19]||(e[19]=t("div",{class:"stat-icon"},"ðŸ“¶",-1)),t("div",de,[t("span",{class:B(["stat-value",m.value.class])},i(m.value.text),3),e[18]||(e[18]=t("span",{class:"stat-label"},"Quality",-1))])])]),t("div",{class:"action-buttons"},[t("button",{class:"action-btn primary",onClick:ot},e[20]||(e[20]=[t("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[t("path",{d:"M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"}),t("polyline",{points:"16,6 12,2 8,6"}),t("line",{x1:"12",y1:"2",x2:"12",y2:"15"})],-1),I(" Share Stream ")])),t("button",{class:"action-btn secondary",onClick:nt},e[21]||(e[21]=[t("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[t("path",{d:"M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"})],-1),I(" Focus Mode ")]))])]),t("div",ce,[e[22]||(e[22]=t("h3",null,"Recent Listeners",-1)),t("div",ue,[(r(!0),l(L,null,U(V.value,s=>(r(),l("div",{key:s,class:"listener-avatar"},i(s.charAt(0).toUpperCase()),1))),128)),x.value>5?(r(),l("div",ve," +"+i(x.value-5),1)):ft("",!0)])])]),t("div",pe,[e[24]||(e[24]=t("div",{class:"chat-header"},[t("h2",null,"Chat")],-1)),t("div",me,[(r(!0),l(L,null,U(F.value,s=>(r(),l("div",{key:s.id,class:B(["message",s.sender===v.value?"own-message":"other-message"])},[t("span",fe,i(s.sender),1),t("span",ge,i(s.text),1),t("span",he,i(W(s.timestamp)),1)],2))),128))],512),t("form",{class:"chat-input-form",onSubmit:gt(rt,["prevent"])},[ht(t("input",{"onUpdate:modelValue":e[0]||(e[0]=s=>k.value=s),type:"text",placeholder:"Type a message..."},null,512),[[yt,k.value]]),e[23]||(e[23]=t("button",{type:"submit"},"Send",-1))],32)])])):(r(),l("div",$t,[e[4]||(e[4]=t("div",{class:"not-found-icon"},[t("svg",{width:"80",height:"80",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[t("path",{d:"M9 9l3 3m0 0l3-3m-3 3V4m-6 8a5 5 0 1 0 10 0"})])],-1)),e[5]||(e[5]=t("h2",null,"Stream Offline",-1)),t("p",null,i(b(d))+" is not streaming right now",1),e[6]||(e[6]=t("p",{class:"subtitle"},"Check back later or follow for notifications",-1)),t("button",{class:"retry-btn",onClick:it},"Try Again")]))]))}},Se=ct(ye,[["__scopeId","data-v-3a4d492a"]]);export{Se as default};
