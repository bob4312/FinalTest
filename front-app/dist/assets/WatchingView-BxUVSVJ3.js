import{_ as ct,x as ut,r as n,o as vt,z as E,p as pt,c as l,a as t,t as i,A as k,l as A,b as mt,F as I,e as L,n as U,d as ft,i as gt,w as ht,v as yt,f as r,s as wt}from"./index-DF7xP-6j.js";import{$ as xt}from"./bundler-DyOlRpoC.js";import{getApps as _t,initializeApp as Ct,getApp as kt}from"https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";import{getFirestore as bt,doc as N,getDoc as St,updateDoc as Dt,collection as B,query as H,where as Mt,getDocs as Pt,onSnapshot as q,orderBy as At,addDoc as It,serverTimestamp as Lt}from"https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";import"./_commonjsHelpers-gnU0ypJ3.js";const Ut={id:"watch-root"},Bt={key:0,class:"loading-container"},Tt={class:"loading-content"},$t={key:1,class:"not-found-container"},Vt={key:2,class:"stream-container"},Rt={class:"left-pane"},Ft={class:"stream-header"},zt={class:"host-info"},Et={class:"host-avatar"},Nt={class:"avatar-circle"},Ht={class:"host-details"},qt={class:"host-name"},Ot={class:"participants-section"},Qt={class:"participants-count"},jt={class:"count-number"},Kt={class:"audio-section"},Wt={class:"audio-container"},Gt={class:"audio-visualizer"},Jt={class:"audio-controls"},Xt={key:0,width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},Yt={key:1,width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},Zt={class:"stream-status"},te={class:"interaction-section"},ee={class:"stream-stats"},se={class:"stat-item"},ae={class:"stat-info"},oe={class:"stat-value"},ne={class:"stat-item"},ie={class:"stat-info"},le={class:"stat-value"},re={class:"stat-item"},de={class:"stat-info"},ce={class:"recent-listeners"},ue={class:"listener-avatars"},ve={key:0,class:"listener-more"},pe={class:"chat-pane"},me={class:"messages-container",ref:"messagesContainer"},fe={class:"msg-sender"},ge={class:"msg-text"},he={class:"msg-time"},ye={__name:"WatchingView",setup(we){const O={apiKey:"AIzaSyAQpMoxAKJrkave5D9e8CqKeLffCCUeGAw",authDomain:"vexa-d596e.firebaseapp.com",projectId:"vexa-d596e",storageBucket:"vexa-d596e.appspot.com",messagingSenderId:"79833394084",appId:"1:79833394084:web:1e5f41859b4125ef342f31"},Q=_t().length===0?Ct(O):kt(),w=bt(Q),d=ut().params.owner,g=n(!0),h=n(!1),b=n(null),u=n(null),x=n(0),_=n(!1),T=n(!1),$=n(0),p=n({text:"Excellent",class:"good"}),V=n(["Alice","Bob","Charlie","Diana","Eve"]);let S=null,D=null,m=null;const R=n([]),C=n(""),f=n("");function j(a){const e=Math.floor(a/60),s=a%60;return`${e}:${s.toString().padStart(2,"0")}`}function K(a){if(!a)return"";const e=a.toDate(),s=e.getHours().toString().padStart(2,"0"),o=e.getMinutes().toString().padStart(2,"0");return`${s}:${o}`}function W(a){const s=`; ${document.cookie}`.split(`; ${a}=`);return s.length===2?decodeURIComponent(s.pop().split(";").shift()):null}async function G(a){const e=B(w,"vexaUsers"),s=H(e,Mt("username","==",a)),o=await Pt(s);return o.empty?null:{id:o.docs[0].id,...o.docs[0].data()}}function J(){_.value=!0,et()}function X(){_.value=!1,st()}function Y(){p.value={text:"Loading...",class:"loading"}}function Z(){p.value={text:"Excellent",class:"good"}}function tt(){u.value&&(u.value.muted=!u.value.muted,T.value=u.value.muted)}function et(){m||(m=setInterval(()=>{$.value++},1e3))}function st(){m&&(clearInterval(m),m=null)}function at(){navigator.share?navigator.share({title:`${d}'s Live Stream`,text:`Listen to ${d}'s live audio stream`,url:window.location.href}):(navigator.clipboard.writeText(window.location.href),alert("Stream link copied to clipboard!"))}function ot(){document.querySelector(".stream-container").classList.toggle("fullscreen-mode")}function nt(){g.value=!0,h.value=!1,window.location.reload()}function it(){const a=N(w,"vexaRooms",d);S=q(a,e=>{if(e.exists()){const o=e.data()["Participants-Usernames"]||[];x.value=o.length,V.value=o.slice(-5)}})}function lt(){const a=B(w,"vexaChats",d,"messages"),e=H(a,At("timestamp","asc"));D=q(e,s=>{const o=[];s.forEach(c=>{const y=c.data();o.push({id:c.id,sender:y.sender,text:y.text,timestamp:y.timestamp})}),R.value=o,E(()=>{const c=dt.value;c&&(c.scrollTop=c.scrollHeight)})})}async function rt(){const a=C.value.trim();if(!a)return;const e=B(w,"vexaChats",d,"messages");try{await It(e,{sender:f.value,text:a,timestamp:Lt()}),C.value=""}catch(s){console.error("Failed to send message:",s)}}vt(async()=>{const a=W("vexaUser");if(!a){console.error("No logged-in username in cookies"),g.value=!1,h.value=!1;return}f.value=a;const e=await G(f.value);if(!e||!e.PeerID){console.error("Viewer not found or missing PeerID for",f.value),g.value=!1,h.value=!1;return}const s=e.PeerID;let o;try{o=await navigator.mediaDevices.getUserMedia({audio:!0})}catch(v){console.warn("No mic access, using empty stream",v),o=new MediaStream}const c=N(w,"vexaRooms",d),y=await St(c);if(!y.exists()){h.value=!1,g.value=!1;return}b.value=y.data(),h.value=!0,g.value=!1,it();const F=b.value["Participants-Usernames"]||[];if(!F.includes(f.value))try{await Dt(c,{"Participants-Usernames":[...F,f.value]})}catch(v){console.error("Failed to update participants:",v)}const M=new xt(s);M.on("open",()=>{const v=b.value["Room-Owner-PeerID"];if(!v){console.error("Host PeerID missing for",d);return}const z=M.call(v,o);z.on("stream",async P=>{await E(),u.value&&(u.value.srcObject=P,u.value.onloadeddata=()=>{p.value={text:"Connected",class:"good"}})}),z.on("error",P=>{console.error("Call error:",P),p.value={text:"Poor",class:"poor"}})}),M.on("error",v=>{console.error("Peer error:",v),p.value={text:"Disconnected",class:"poor"}}),lt()}),pt(()=>{S&&S(),D&&D(),m&&clearInterval(m)});const dt=n(null);return(a,e)=>(r(),l("div",Ut,[g.value?(r(),l("div",Bt,[e[3]||(e[3]=t("div",{class:"loading-spinner"},null,-1)),t("div",Tt,[e[1]||(e[1]=t("h2",null,"Connecting to Stream...",-1)),t("p",null,"Finding "+i(k(d))+"'s audio stream",1),e[2]||(e[2]=t("div",{class:"loading-dots"},[t("span"),t("span"),t("span")],-1))])])):h.value?(r(),l("div",Vt,[t("div",Rt,[t("div",Ft,[t("div",zt,[t("div",Et,[t("div",Nt,i(k(d).charAt(0).toUpperCase()),1),e[7]||(e[7]=t("div",{class:"live-indicator"},[t("div",{class:"live-dot"}),A(" LIVE ")],-1))]),t("div",Ht,[t("h1",qt,i(k(d)),1),e[8]||(e[8]=t("p",{class:"stream-title"},"Live Audio Stream",-1))])]),t("div",Ot,[t("div",Qt,[e[9]||(e[9]=mt('<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-v-19dd8750><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" data-v-19dd8750></path><circle cx="9" cy="7" r="4" data-v-19dd8750></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87" data-v-19dd8750></path><path d="M16 3.13a4 4 0 0 1 0 7.75" data-v-19dd8750></path></svg>',1)),t("span",jt,i(x.value),1),e[10]||(e[10]=t("span",{class:"count-label"},"listening",-1))]),e[11]||(e[11]=t("div",{class:"participants-pulse"},null,-1))])]),t("div",Kt,[t("div",Wt,[t("div",Gt,[(r(),l(I,null,L(12,s=>t("div",{class:"visualizer-bars",key:s,style:wt({animationDelay:s*.1+"s"})},null,4)),64))]),t("audio",{ref_key:"remoteAudio",ref:u,controls:"",autoplay:"",playsinline:"",class:"audio-player",onPlay:J,onPause:X,onLoadstart:Y,onCanplay:Z},null,544),t("div",Jt,[t("button",{class:"volume-btn",onClick:tt},[T.value?(r(),l("svg",Yt,e[13]||(e[13]=[t("polygon",{points:"11 5 6 9 2 9 2 15 6 15 11 19 11 5"},null,-1),t("line",{x1:"23",y1:"9",x2:"17",y2:"15"},null,-1),t("line",{x1:"17",y1:"9",x2:"23",y2:"15"},null,-1)]))):(r(),l("svg",Xt,e[12]||(e[12]=[t("polygon",{points:"11 5 6 9 2 9 2 15 6 15 11 19 11 5"},null,-1),t("path",{d:"M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"},null,-1)])))]),t("div",Zt,[t("div",{class:U(["status-dot",{active:_.value}])},null,2),t("span",null,i(_.value?"Live":"Paused"),1)])])])]),t("div",te,[t("div",ee,[t("div",se,[e[15]||(e[15]=t("div",{class:"stat-icon"},"ðŸŽµ",-1)),t("div",ae,[t("span",oe,i(j($.value)),1),e[14]||(e[14]=t("span",{class:"stat-label"},"Stream Time",-1))])]),t("div",ne,[e[17]||(e[17]=t("div",{class:"stat-icon"},"ðŸ‘¥",-1)),t("div",ie,[t("span",le,i(x.value),1),e[16]||(e[16]=t("span",{class:"stat-label"},"Listeners",-1))])]),t("div",re,[e[19]||(e[19]=t("div",{class:"stat-icon"},"ðŸ“¶",-1)),t("div",de,[t("span",{class:U(["stat-value",p.value.class])},i(p.value.text),3),e[18]||(e[18]=t("span",{class:"stat-label"},"Quality",-1))])])]),t("div",{class:"action-buttons"},[t("button",{class:"action-btn primary",onClick:at},e[20]||(e[20]=[t("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[t("path",{d:"M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"}),t("polyline",{points:"16,6 12,2 8,6"}),t("line",{x1:"12",y1:"2",x2:"12",y2:"15"})],-1),A(" Share Stream ")])),t("button",{class:"action-btn secondary",onClick:ot},e[21]||(e[21]=[t("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[t("path",{d:"M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"})],-1),A(" Focus Mode ")]))])]),t("div",ce,[e[22]||(e[22]=t("h3",null,"Recent Listeners",-1)),t("div",ue,[(r(!0),l(I,null,L(V.value,s=>(r(),l("div",{key:s,class:"listener-avatar"},i(s.charAt(0).toUpperCase()),1))),128)),x.value>5?(r(),l("div",ve," +"+i(x.value-5),1)):ft("",!0)])])]),t("div",pe,[e[24]||(e[24]=t("div",{class:"chat-header"},[t("h2",null,"Chat")],-1)),t("div",me,[(r(!0),l(I,null,L(R.value,s=>(r(),l("div",{key:s.id,class:U(["message",s.sender===f.value?"own-message":"other-message"])},[t("span",fe,i(s.sender),1),t("span",ge,i(s.text),1),t("span",he,i(K(s.timestamp)),1)],2))),128))],512),t("form",{class:"chat-input-form",onSubmit:gt(rt,["prevent"])},[ht(t("input",{"onUpdate:modelValue":e[0]||(e[0]=s=>C.value=s),type:"text",placeholder:"Type a message..."},null,512),[[yt,C.value]]),e[23]||(e[23]=t("button",{type:"submit"},"Send",-1))],32)])])):(r(),l("div",$t,[e[4]||(e[4]=t("div",{class:"not-found-icon"},[t("svg",{width:"80",height:"80",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[t("path",{d:"M9 9l3 3m0 0l3-3m-3 3V4m-6 8a5 5 0 1 0 10 0"})])],-1)),e[5]||(e[5]=t("h2",null,"Stream Offline",-1)),t("p",null,i(k(d))+" is not streaming right now",1),e[6]||(e[6]=t("p",{class:"subtitle"},"Check back later or follow for notifications",-1)),t("button",{class:"retry-btn",onClick:nt},"Try Again")]))]))}},De=ct(ye,[["__scopeId","data-v-19dd8750"]]);export{De as default};
