import{_ as J,x as X,r as m,m as Y,o as Z,y as ee,c as r,a as e,d as se,l as k,t as d,F as L,e as M,i as te,w as oe,v as ae,z as N,u as ne,f as l}from"./index-D1wTDwKK.js";import{$ as T}from"./bundler-DyOlRpoC.js";import{getApps as ie,initializeApp as re,getApp as le}from"https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";import{getFirestore as ce,doc as _,onSnapshot as S,collection as C,query as P,orderBy as de,where as H,getDocs as B,updateDoc as O,deleteDoc as V,addDoc as ue,serverTimestamp as ve}from"https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";import"./_commonjsHelpers-gnU0ypJ3.js";const me={id:"live-root"},pe={key:0,class:"loading"},he={key:1,id:"live-section"},fe={class:"stream-layout"},_e={class:"stream-info"},ge={class:"stream-header"},we={class:"stream-title"},ye={class:"stream-description"},xe={class:"stream-meta"},Ce={class:"meta-item"},be={class:"meta-content"},ke={class:"meta-value"},De={class:"meta-item"},Re={class:"meta-content"},Ae={class:"meta-value"},Ie={class:"meta-item"},Ue={class:"meta-content"},Le={class:"meta-value"},Me={key:0,class:"stop-section"},Pe={class:"audio-section"},Be={class:"audio-header"},Ve={key:0},Ee={key:1},Ne={class:"audio-visualizer"},Te={class:"audio-player-container"},Se={class:"participants-section"},He={class:"participants-grid"},Oe={class:"participant-avatar"},ze={class:"participant-name"},je={class:"chat-section"},qe={class:"message-avatar"},Fe={class:"message-content"},$e={class:"message-sender"},Ke={class:"message-text"},Qe=["disabled"],We={__name:"AudioLiveView",setup(Ge){const z={apiKey:"AIzaSyAQpMoxAKJrkave5D9e8CqKeLffCCUeGAw",authDomain:"vexa-d596e.firebaseapp.com",projectId:"vexa-d596e",storageBucket:"vexa-d596e.appspot.com",messagingSenderId:"79833394084",appId:"1:79833394084:web:1e5f342f31"},j=ie().length===0?re(z):le(),a=ce(j),q=X(),F=ne(),n=q.params.owner,p=decodeURIComponent((document.cookie.split("; ").find(o=>o.startsWith("vexaUser="))||"").split("=")[1]||""),v=m({}),g=m([]),E=m([]),w=m(""),D=m(!1),y=Y(()=>v.value["Room-Owner"]===p),x=m(null),h=m(null);let c=null,R=null,A=null;const b=m(null);function $(){N(()=>{b.value&&(b.value.scrollTop=b.value.scrollHeight)})}async function I(){c&&c.destroy(),x.value&&x.value.getTracks().forEach(s=>s.stop());const o=_(a,"vexaRooms",n);try{await V(o),console.log("Room document deleted.")}catch(s){console.error("Error deleting room:",s)}try{const s=C(a,"vexaChats",n,"messages"),u=(await B(s)).docs.map(f=>V(_(a,"vexaChats",n,"messages",f.id)));await Promise.all(u),console.log("All chat messages deleted.")}catch(s){console.error("Error deleting chat messages:",s)}try{await V(_(a,"vexaChats",n)),console.log("Chat document deleted.")}catch(s){console.error("Error deleting chat parent document:",s)}try{const s=C(a,"vexaUsers"),t=P(s,H("username","==",n)),u=await B(t);if(!u.empty){const i=u.docs[0].id,U=_(a,"vexaUsers",i);await O(U,{isLiveNow:!1}),console.log("isLiveNow set to false for user:",n)}}catch(s){console.error("Error updating isLiveNow flag:",s)}F.push("/home")}async function K(){try{x.value=await navigator.mediaDevices.getUserMedia({audio:!0}),await N(),h.value&&(h.value.srcObject=x.value,await h.value.play().catch(()=>{}))}catch(o){console.error("Host audio error:",o)}}function Q(){c=new T(v.value["Room-Owner-PeerID"]),c.on("call",o=>{o.answer(x.value)})}async function W(){const o=C(a,"vexaUsers"),s=P(o,H("username","==",p)),t=await B(s),u=t.empty?null:t.docs[0].data().PeerID;if(!u){console.error("Viewer PeerID not found for",p);return}c=new T(u),c.on("open",()=>{c.call(v.value["Room-Owner-PeerID"],null).on("stream",U=>{h.value&&(h.value.srcObject=U)})}),c.on("error",i=>console.error("Peer error:",i));const f=_(a,"vexaRooms",n);if(!g.value.includes(p))try{await O(f,{"Participants-Usernames":[...g.value,p]})}catch(i){console.warn("Could not update participants:",i)}}async function G(){const o=w.value.trim();if(o)try{const s=C(a,"vexaChats",n,"messages");await ue(s,{sender:p,text:o,timestamp:ve()}),w.value=""}catch(s){console.error("Failed to send chat message:",s)}}return Z(()=>{const o=_(a,"vexaRooms",n);R=S(o,s=>{if(!s.exists()){console.error("No room for owner:",n);return}if(v.value={id:s.id,...s.data()},g.value=s.data()["Participants-Usernames"]||[],!D.value){D.value=!0,y.value?K().then(Q):W();const t=C(a,"vexaChats",n,"messages"),u=P(t,de("timestamp","asc"));A=S(u,f=>{E.value=f.docs.map(i=>({id:i.id,sender:i.data().sender,text:i.data().text,timestamp:i.data().timestamp})),$()})}})}),window.addEventListener("beforeunload",()=>{y.value&&I()}),ee(()=>{y.value?I():c&&c.destroy(),R&&R(),A&&A()}),(o,s)=>(l(),r("div",me,[D.value?(l(),r("div",he,[e("div",fe,[e("section",_e,[e("div",ge,[s[2]||(s[2]=e("div",{class:"live-indicator"},[e("span",{class:"live-dot"}),k(" LIVE ")],-1)),e("h1",we,d(v.value["Room-Name"]),1),e("p",ye,d(v.value["Room-Desc"]),1)]),e("div",xe,[e("div",Ce,[s[4]||(s[4]=e("div",{class:"meta-icon"},"👤",-1)),e("div",be,[s[3]||(s[3]=e("span",{class:"meta-label"},"Host",-1)),e("span",ke,d(v.value["Room-Owner"]),1)])]),e("div",De,[s[6]||(s[6]=e("div",{class:"meta-icon"},"📁",-1)),e("div",Re,[s[5]||(s[5]=e("span",{class:"meta-label"},"Categories",-1)),e("span",Ae,d(v.value["Room-Category"].join(", ")),1)])]),e("div",Ie,[s[8]||(s[8]=e("div",{class:"meta-icon"},"👥",-1)),e("div",Ue,[s[7]||(s[7]=e("span",{class:"meta-label"},"Viewers",-1)),e("span",Le,d(g.value.length),1)])])]),y.value?(l(),r("div",Me,[e("button",{onClick:I,class:"stop-btn"},s[9]||(s[9]=[e("span",{class:"btn-icon"},"🛑",-1),k(" Stop Stream ")]))])):se("",!0),e("div",Pe,[e("div",Be,[e("h3",null,[y.value?(l(),r("span",Ve,"🎧 Live Monitor")):(l(),r("span",Ee,"🔊 Listening"))]),e("div",Ne,[(l(),r(L,null,M(5,t=>e("div",{class:"wave-bar",key:t})),64))])]),e("div",Te,[e("audio",{ref_key:"localAudio",ref:h,controls:"",autoplay:"",playsinline:"",class:"audio-player"},null,512)])]),e("div",Se,[s[10]||(s[10]=e("h3",{class:"participants-title"},[e("span",{class:"online-dot"}),k(" Currently Watching ")],-1)),e("div",He,[(l(!0),r(L,null,M(g.value,t=>(l(),r("div",{key:t,class:"participant-card"},[e("div",Oe,d(t.charAt(0).toUpperCase()),1),e("span",ze,d(t),1)]))),128))])])]),e("section",je,[s[12]||(s[12]=e("div",{class:"chat-header"},[e("h3",null,"💬 Live Chat"),e("div",{class:"chat-status"},[e("div",{class:"status-dot"}),k(" Active ")])],-1)),e("div",{class:"chat-box",ref_key:"chatBox",ref:b},[(l(!0),r(L,null,M(E.value,t=>(l(),r("div",{key:t.id,class:"chat-message"},[e("div",qe,d(t.sender.charAt(0).toUpperCase()),1),e("div",Fe,[e("span",$e,d(t.sender),1),e("span",Ke,d(t.text),1)])]))),128))],512),e("form",{onSubmit:te(G,["prevent"]),class:"chat-input"},[oe(e("input",{"onUpdate:modelValue":s[0]||(s[0]=t=>w.value=t),placeholder:"Type your message...",class:"chat-input-field"},null,512),[[ae,w.value]]),e("button",{type:"submit",disabled:!w.value.trim(),class:"send-btn"},s[11]||(s[11]=[e("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[e("path",{d:"m22 2-7 20-4-9-9-4z"}),e("path",{d:"M22 2 11 13"})],-1)]),8,Qe)],32)])])])):(l(),r("div",pe,s[1]||(s[1]=[e("div",{class:"loading-spinner"},null,-1),e("p",null,"Loading stream data...",-1)])))]))}},ss=J(We,[["__scopeId","data-v-350e418d"]]);export{ss as default};
